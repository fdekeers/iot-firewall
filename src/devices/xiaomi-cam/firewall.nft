#!/usr/sbin/nft -f

table netdev xiaomi-cam {

    chain dhcp-boot {

        # Chain configuration
        type filter hook ingress device enp0s8 priority 0;

        # Match DHCP discover/request packets (UDP 68 -> 67)
        ip saddr 0.0.0.0 ip daddr 255.255.255.255 udp sport 68 udp dport 67 queue num 1;
        # Match DHCP offer/ack packets (UDP 67 -> 68)
        ip saddr 192.168.1.1 ip daddr 192.168.1.161 udp sport 67 udp sport 67 queue num 1;

    }

    chain dns {

        type filter hook ingress device enp0s8 priority 0;
        
        # Match DNS query packets (UDP * -> 53)
        ip saddr 192.168.1.161 ip daddr 192.168.1.1 udp dport 53 queue num 2;
        # Match DNS response packets (UDP 53 -> *)
        ip saddr 192.168.1.1 ip daddr 192.168.1.161 udp sport 53 queue num 2;
        
    }

    chain http {
        
        type filter hook ingress device enp0s8 priority 0;

        # Match HTTP requests  (TCP * -> 80)
        # Match HTTP responses (TCP 80 -> *)
    }

    chain open-app-local {

        type filter hook ingress device enp0s8 priority 0; policy drop;

        # IGMP membership report
        ip saddr 192.168.1.0/24 ip daddr 224.0.0.251 ip protocol igmp queue num 10;
        # mDNS query
        ip saddr 192.168.1.0/24 udp sport 5353 udp dport 5353 queue num 11;
        # UDP broadcast
        ip saddr 192.168.1.0/24 ip daddr 192.168.1.255 udp dport {54321, 32108} queue num 12;
        # ARP request
        arp operation request arp saddr ether 78:8b:2a:b2:20:ea arp daddr ether 00:00:00:00:00:00 arp saddr ip 192.168.1.161 arp daddr ip 192.168.1.0/24 queue num 13;
        # ARP reply
        arp operation reply arp saddr ether 3c:cd:5d:a2:a9:d7 arp daddr ether 78:8b:2a:b2:20:ea arp saddr ip 192.168.1.0/24 arp daddr ip 192.168.1.161 queue num 14;
        # UDP burst & background (in both directions)
        #ip saddr 192.168.1.161 ip daddr 192.168.1.0/24 limit rate 10/second burst 20 packets meta length >= 40 meta length <= 300 queue num 15;
        #ip saddr 192.168.1.0/24 ip daddr 192.168.1.161 limit rate 10/second burst 20 packets meta length >= 40 meta length <= 300 queue num 15;

    }

}
