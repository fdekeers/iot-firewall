#!/usr/sbin/nft -f

{% macro write_nft_table(data, is_arp=False) %}
{% set family = "netdev" if is_arp else "inet" %}
{% if data["chains"]|length > 0 %}
table {{family}} {{device}} {

    # Counters
    {% for policy in data["counters"] %}
    {% if "out" in data["counters"][policy] and "in" in data["counters"][policy] %}
    counter {{policy}}-out {}
    counter {{policy}}-in {}
    {% else %}
    counter {{policy}} {}
    {% endif %}
    {% endfor %}

    # Chains
    {% for chain in data["chains"] %}
    chain {{chain}} {
        
        # Chain configuration
        type filter hook ingress device enp0s8 priority 0; policy accept;

        # Rules
        {% for rule in data["chains"][chain] %}
        {{rule["forward"]}}
        {% if "backward" in rule %}
        {{rule["backward"]}}
        {% endif %}
        {% endfor %}

    }
    
    {% endfor %}

    # Last chain, drops any packet that was not matched
    chain final {
        type filter hook ingress device enp0s8 priority 1; policy drop;
    }

}
{% endif %}
{% endmacro %}

{{ write_nft_table(nft_inet, is_arp=False) }}
{{ write_nft_table(nft_arp, is_arp=True) }}
